import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, updateProfile } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, addDoc, getDocs, onSnapshot, query, updateDoc, deleteDoc, where } from 'firebase/firestore';
import { Book, User, Award, LogOut, Plus, Trash2, CheckCircle, XCircle, ChevronLeft, Shield } from 'lucide-react';

// --- KONFIGURASI FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pancasila-v1';

// --- DATA MODUL DEFAULT (Fallback jika DB kosong) ---
const defaultModules = [
  { 
    id: 'sejarah-pancasila', 
    title: 'Sejarah Perumusan Pancasila', 
    kelas: 'X', 
    durasi: '45', 
    konten: 'Sidang BPUPKI pertama membahas dasar negara. Tokoh yang mengusulkan antara lain M. Yamin, Soepomo, dan Soekarno. Kemudian terbentuklah Piagam Jakarta sebagai kesepakatan awal.' 
  },
  { 
    id: 'demokrasi-indonesia', 
    title: 'Dinamika Demokrasi', 
    kelas: 'XI', 
    durasi: '60', 
    konten: 'Demokrasi di Indonesia mengalami pasang surut, mulai dari Demokrasi Parlementer, Terpimpin, hingga Demokrasi Pancasila. Intinya adalah kedaulatan berada di tangan rakyat.' 
  },
  { 
    id: 'pelanggaran-hak', 
    title: 'Pelanggaran Hak & Kewajiban', 
    kelas: 'XII', 
    durasi: '50', 
    konten: 'Pelanggaran hak warga negara terjadi ketika warga negara tidak dapat menikmati atau memperoleh haknya. Faktor penyebabnya bisa internal (egoisme) atau eksternal (penyalahgunaan kekuasaan).' 
  }
];

// --- SOAL KUIS (Hardcoded untuk demo ini agar sederhana) ---
const quizDatabase = {
  'sejarah-pancasila': [
    { q: 'Siapa yang mengusulkan nama Pancasila?', opt: ['M. Yamin', 'Soepomo', 'Ir. Soekarno', 'Hatta'], ans: 2 },
    { q: 'Kapan hari lahir Pancasila diperingati?', opt: ['1 Juni', '17 Agustus', '18 Agustus', '22 Juni'], ans: 0 }
  ],
  'demokrasi-indonesia': [
    { q: 'Kedaulatan berada di tangan...', opt: ['Presiden', 'DPR', 'Rakyat', 'MPR'], ans: 2 },
    { q: 'Demokrasi Pancasila mengutamakan...', opt: ['Voting', 'Musyawarah', 'Otoriter', 'Liberal'], ans: 1 }
  ],
  'pelanggaran-hak': [
    { q: 'Membuang sampah sembarangan melanggar...', opt: ['Hak', 'Kewajiban', 'Hukum Pidana', 'Adat'], ans: 1 },
    { q: 'Faktor internal pelanggaran hak adalah...', opt: ['Aparat lemah', 'Sikap egois', 'Teknologi', 'Kesenjangan'], ans: 1 }
  ]
};

const App = () => {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [view, setView] = useState('login'); // login, register, dashboard, detail, quiz, result, addMateri
  const [error, setError] = useState('');
  const [notification, setNotification] = useState(null);
  const [modules, setModules] = useState([]);
  const [selectedModule, setSelectedModule] = useState(null);
  const [students, setStudents] = useState([]);
  
  // State Login/Register
  const [authMode, setAuthMode] = useState('siswa'); // siswa / guru
  const [form, setForm] = useState({ username: '', password: '', fullname: '', kelas: 'X', jurusan: 'ULP', teacherCode: '' });

  // State Quiz
  const [quizState, setQuizState] = useState({ idx: 0, correct: 0, answers: [] });
  
  // State Guru Tambah Materi
  const [newMateri, setNewMateri] = useState({ title: '', kelas: 'X', durasi: '', konten: '' });

  // --- INIT AUTH & DATA ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) {
        setUserData(null);
        setView('login');
      }
    });
    return () => unsubscribe();
  }, []);

  // --- FETCH USER DATA ---
  useEffect(() => {
    if (!user) return;
    
    // Perbaikan Path: Menambahkan 'data' agar segmen genap (6 segmen)
    // artifacts / appId / public / data / users / userId
    const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
    
    const unsubUser = onSnapshot(userDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setUserData(docSnap.data());
        setView('dashboard');
      } else {
        // Jika user anonim belum punya data profil, tetap di login/register
      }
    }, (err) => console.error("Err fetch user:", err));

    return () => unsubUser();
  }, [user]);

  // --- FETCH MODULES (PUBLIC) ---
  useEffect(() => {
    if(!user) return;
    // Query path sudah benar (ganjil untuk collection): artifacts / appId / public / data / modules
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'modules'));
    const unsub = onSnapshot(q, (snap) => {
      const fetched = snap.docs.map(d => ({id: d.id, ...d.data()}));
      const combined = [...defaultModules.filter(dm => !fetched.find(f => f.id === dm.id)), ...fetched];
      setModules(combined);
    }, (err) => console.log("Err modules", err)); 
    return () => unsub();
  }, [user]);

  // --- FETCH STUDENTS (TEACHER ONLY) ---
  useEffect(() => {
    if(!user || !userData || userData.role !== 'guru') return;
    
    // Perbaikan Path: Menambahkan 'data' agar sesuai struktur public
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('role', '==', 'siswa'));
    const unsub = onSnapshot(q, (snap) => {
      setStudents(snap.docs.map(d => ({id: d.id, ...d.data()})));
    }, (err) => console.log("Err students", err));
    return () => unsub();
  }, [user, userData]);


  // --- HANDLERS ---

  const showNotif = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const handleRegister = async () => {
    if (!form.username || !form.password || !form.fullname) return setError("Semua kolom wajib diisi!");
    if (authMode === 'guru' && form.teacherCode !== 'PANCA2024') return setError("Kode Guru Salah!");

    try {
      const role = authMode;
      const newUser = {
        username: form.username,
        password: form.password, 
        name: form.fullname,
        role: role,
        createdAt: new Date().toISOString(),
        scores: {}
      };

      if (role === 'siswa') {
        newUser.kelas = form.kelas;
        newUser.jurusan = form.jurusan;
      }

      // Perbaikan Path: Menambahkan 'data'
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), newUser);
      
      showNotif("Pendaftaran Berhasil!", "success");
    } catch (e) {
      setError(e.message);
    }
  };

  const handleLogin = async () => {
    try {
      // Perbaikan Path: Menambahkan 'data'
      const q = query(
        collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
        where('username', '==', form.username),
        where('password', '==', form.password),
        where('role', '==', authMode)
      );
      
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        setError("Login Gagal. Cek username/password/peran.");
      } else {
        const foundUser = querySnapshot.docs[0].data();
        setUserData(foundUser);
        setView('dashboard');
      }
    } catch (e) {
      setError("Terjadi kesalahan koneksi.");
    }
  };

  const handleSaveMateri = async () => {
    if (!newMateri.title || !newMateri.konten) return showNotif("Judul & Konten wajib diisi", "error");
    
    try {
      // Path sudah benar: artifacts / appId / public / data / modules
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'modules'), {
        ...newMateri,
        createdAt: new Date().toISOString()
      });
      showNotif("Materi Berhasil Disimpan ke Database!", "success");
      setNewMateri({ title: '', kelas: 'X', durasi: '', konten: '' });
      setView('dashboard');
    } catch (e) {
      showNotif("Gagal menyimpan: " + e.message, "error");
    }
  };

  const handleDeleteSiswa = async (id) => {
    try {
        // Perbaikan Path: Menambahkan 'data'
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
        showNotif("Data siswa dihapus");
    } catch(e) {
        showNotif("Gagal menghapus", "error");
    }
  };

  const handleStartQuiz = (modulId) => {
    const soal = quizDatabase[modulId] || quizDatabase['sejarah-pancasila'];
    setQuizState({ modulId, idx: 0, correct: 0, answers: [], questions: soal });
    setView('quiz');
  };

  const handleAnswer = async (ansIdx) => {
    const isCorrect = ansIdx === quizState.questions[quizState.idx].ans;
    const newCorrect = isCorrect ? quizState.correct + 1 : quizState.correct;
    
    if (quizState.idx + 1 < quizState.questions.length) {
      setQuizState({ ...quizState, idx: quizState.idx + 1, correct: newCorrect });
    } else {
      const finalScore = Math.round((newCorrect / quizState.questions.length) * 100);
      
      if (userData && userData.role === 'siswa') {
        try {
             // Perbaikan Path: Menambahkan 'data'
             const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', userData.username));
             const snaps = await getDocs(q);
             if(!snaps.empty) {
                 const docId = snaps.docs[0].id;
                 const currentScores = snaps.docs[0].data().scores || {};
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', docId), {
                     scores: { ...currentScores, [quizState.modulId]: finalScore }
                 });
             }
        } catch(e) { console.error("Gagal save score", e); }
      }
      
      setQuizState({ ...quizState, finalScore });
      setView('result');
    }
  };

  // --- VIEWS ---

  if (view === 'login' || view === 'register') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4 font-sans text-slate-800">
        <div className="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 to-white"></div>
          
          <h1 className="text-3xl font-black text-center mb-2 tracking-tight">üáÆüá© PANCASILA<br/><span className="text-red-600">ACADEMY</span></h1>
          <p className="text-center text-slate-500 mb-6 text-sm">Platform Pembelajaran Ideologi Bangsa</p>

          {error && <div className="bg-red-50 text-red-600 p-3 rounded-xl mb-4 text-sm font-semibold flex items-center gap-2"><XCircle size={16}/> {error}</div>}
          {notification && <div className="bg-green-50 text-green-600 p-3 rounded-xl mb-4 text-sm font-semibold flex items-center gap-2"><CheckCircle size={16}/> {notification.msg}</div>}

          <div className="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
            <button onClick={() => setAuthMode('siswa')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${authMode === 'siswa' ? 'bg-white shadow text-slate-900' : 'text-slate-400 hover:text-slate-600'}`}>üéì Siswa</button>
            <button onClick={() => setAuthMode('guru')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${authMode === 'guru' ? 'bg-white shadow text-slate-900' : 'text-slate-400 hover:text-slate-600'}`}>üíº Guru</button>
          </div>

          <div className="space-y-3">
            {view === 'register' && (
              <>
                <input value={form.fullname} onChange={e=>setForm({...form, fullname: e.target.value})} placeholder="Nama Lengkap" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 transition-all" />
                {authMode === 'siswa' ? (
                   <div className="flex gap-2">
                     <select value={form.kelas} onChange={e=>setForm({...form, kelas: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl flex-1 font-bold text-slate-600">
                       <option>X</option><option>XI</option><option>XII</option>
                     </select>
                     <select value={form.jurusan} onChange={e=>setForm({...form, jurusan: e.target.value})} className="p-3 bg-slate-50 border border-slate-200 rounded-xl flex-1 font-bold text-slate-600">
                       <option>ULP</option><option>PF</option><option>TF</option>
                     </select>
                   </div>
                ) : (
                  <input type="password" value={form.teacherCode} onChange={e=>setForm({...form, teacherCode: e.target.value})} placeholder="Kode Guru (PANCA2024)" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />
                )}
              </>
            )}
            
            <input value={form.username} onChange={e=>setForm({...form, username: e.target.value})} placeholder="Username" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />
            <input type="password" value={form.password} onChange={e=>setForm({...form, password: e.target.value})} placeholder="Password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />
            
            <button onClick={view === 'login' ? handleLogin : handleRegister} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95 flex justify-center items-center gap-2">
              {view === 'login' ? 'Masuk Sekarang' : 'Daftar Akun'} <ChevronLeft className="rotate-180" size={18}/>
            </button>
          </div>

          <p className="text-center mt-6 text-sm text-slate-400">
            {view === 'login' ? 'Belum punya akun?' : 'Sudah punya akun?'} 
            <span onClick={() => {setView(view === 'login' ? 'register' : 'login'); setError('')}} className="text-red-600 font-bold cursor-pointer ml-1 hover:underline">
              {view === 'login' ? 'Daftar' : 'Login'}
            </span>
          </p>
        </div>
      </div>
    );
  }

  // --- DASHBOARD LAYOUT ---
  const Layout = ({ children }) => (
    <div className="min-h-screen bg-slate-50 pb-20 font-sans text-slate-800">
      {notification && (
        <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-xl font-bold text-white flex items-center gap-2 animate-bounce ${notification.type==='error'?'bg-red-500':'bg-green-500'}`}>
          {notification.type === 'error' ? <XCircle/> : <CheckCircle/>} {notification.msg}
        </div>
      )}
      
      <nav className="bg-white px-4 py-3 border-b sticky top-0 z-20 shadow-sm flex justify-between items-center">
        <div className="flex items-center gap-2 font-black text-slate-800 text-lg">
           <Shield className="text-red-600 fill-current" /> 
           <span className="hidden sm:inline">PANCASILA ACADEMY</span>
           <span className="sm:hidden">PANCASILA</span>
        </div>
        <div className="flex items-center gap-4">
          <div className="text-right hidden sm:block">
            <div className="font-bold text-sm leading-tight">{userData?.name}</div>
            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-100 px-2 py-0.5 rounded-full inline-block">{userData?.role}</div>
          </div>
          <button onClick={() => {setUser(null); setView('login');}} className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition-colors">
            <LogOut size={18} />
          </button>
        </div>
      </nav>
      
      <main className="max-w-4xl mx-auto p-4 mt-2">
        {children}
      </main>
    </div>
  );

  // --- TEACHER VIEW ---
  if (view === 'dashboard' && userData?.role === 'guru') {
    return (
      <Layout>
        <div className="bg-slate-900 text-white p-8 rounded-3xl mb-6 relative overflow-hidden shadow-xl">
          <div className="relative z-10">
             <h2 className="text-3xl font-bold mb-2">Panel Instruktur</h2>
             <p className="text-slate-400">Kelola materi dan pantau perkembangan siswa.</p>
          </div>
          <div className="absolute -right-10 -bottom-20 text-9xl opacity-10 rotate-12">üë®‚Äçüè´</div>
        </div>

        <div className="grid md:grid-cols-2 gap-4 mb-8">
           <button onClick={() => setView('addMateri')} className="bg-white p-6 rounded-2xl border-2 border-dashed border-slate-300 hover:border-red-500 hover:bg-red-50 transition-all group flex flex-col items-center justify-center text-slate-400 hover:text-red-600 gap-2 h-40">
             <div className="bg-slate-100 p-4 rounded-full group-hover:bg-white group-hover:shadow-md transition-all"><Plus size={32}/></div>
             <span className="font-bold">Tambah Modul Baru</span>
           </button>
           
           <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-center h-40">
             <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Total Siswa Aktif</div>
             <div className="text-5xl font-black text-slate-800">{students.length}</div>
             <div className="text-sm text-green-600 font-bold mt-2 flex items-center gap-1"><User size={14}/> Terdaftar</div>
           </div>
        </div>

        <h3 className="font-bold text-xl mb-4 flex items-center gap-2"><User className="text-red-600"/> Daftar Siswa</h3>
        <div className="space-y-3">
          {students.map(s => (
            <div key={s.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
               <div className="flex items-center gap-4">
                 <div className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 font-bold">
                   {s.name.charAt(0)}
                 </div>
                 <div>
                   <div className="font-bold text-slate-800">{s.name}</div>
                   <div className="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-0.5 rounded inline-block mt-1">{s.kelas} - {s.jurusan}</div>
                 </div>
               </div>
               <div className="flex items-center gap-4">
                 <div className="text-right hidden sm:block">
                   <div className="text-[10px] text-slate-400 font-bold uppercase">Rata-rata Nilai</div>
                   <div className="font-bold text-lg">
                     {s.scores && Object.values(s.scores).length > 0 
                       ? Math.round(Object.values(s.scores).reduce((a,b)=>a+b,0)/Object.values(s.scores).length) 
                       : '-'}
                   </div>
                 </div>
                 <button onClick={() => handleDeleteSiswa(s.id)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all">
                   <Trash2 size={16}/>
                 </button>
               </div>
            </div>
          ))}
          {students.length === 0 && <div className="text-center py-10 text-slate-400 italic bg-slate-50 rounded-xl border border-dashed">Belum ada siswa terdaftar.</div>}
        </div>
      </Layout>
    );
  }

  // --- TEACHER ADD MATERIAL ---
  if (view === 'addMateri') {
      return (
          <Layout>
              <button onClick={() => setView('dashboard')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors">
                  <ChevronLeft size={20}/> Kembali ke Dashboard
              </button>
              
              <div className="bg-white rounded-3xl p-8 shadow-xl border border-slate-100 max-w-2xl mx-auto">
                  <h2 className="text-2xl font-black text-slate-800 mb-6">Tulis Materi Baru</h2>
                  <div className="space-y-4">
                      <div>
                          <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Judul Modul</label>
                          <input value={newMateri.title} onChange={e=>setNewMateri({...newMateri, title: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl border-2 border-transparent focus:border-red-500 focus:bg-white transition-all font-bold text-lg" placeholder="Contoh: Anti Korupsi" />
                      </div>
                      <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Kelas</label>
                            <select value={newMateri.kelas} onChange={e=>setNewMateri({...newMateri, kelas: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none">
                                <option>X</option><option>XI</option><option>XII</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Durasi (Menit)</label>
                            <input type="number" value={newMateri.durasi} onChange={e=>setNewMateri({...newMateri, durasi: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none" placeholder="45" />
                          </div>
                      </div>
                      <div>
                          <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Isi Materi</label>
                          <textarea value={newMateri.konten} onChange={e=>setNewMateri({...newMateri, konten: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl border-2 border-transparent focus:border-red-500 focus:bg-white transition-all h-48 leading-relaxed" placeholder="Tuliskan konten materi pembelajaran di sini..."></textarea>
                      </div>
                      <button onClick={handleSaveMateri} className="w-full py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 shadow-lg flex justify-center items-center gap-2 mt-4">
                          <CheckCircle size={20}/> Simpan Materi ke Database
                      </button>
                  </div>
              </div>
          </Layout>
      )
  }

  // --- STUDENT VIEW ---
  if (view === 'dashboard' && userData?.role === 'siswa') {
    const myModules = modules.filter(m => m.kelas === userData.kelas);
    
    return (
      <Layout>
        <div className="bg-gradient-to-r from-red-600 to-red-500 text-white p-8 rounded-3xl mb-8 relative overflow-hidden shadow-lg">
          <div className="relative z-10">
            <h2 className="text-3xl font-bold mb-1">Halo, {userData.name.split(' ')[0]}! üëã</h2>
            <p className="opacity-90">Siap belajar Pancasila hari ini?</p>
            <div className="mt-4 inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-lg text-sm font-bold">
              <Award size={16}/> Skor Kamu: {userData.scores ? Math.round(Object.values(userData.scores).reduce((a,b)=>a+b,0)/Object.values(userData.scores).length || 0) : 0}
            </div>
          </div>
          <div className="absolute right-0 bottom-0 text-9xl opacity-20 transform translate-y-4">üáÆüá©</div>
        </div>

        <h3 className="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2"><Book className="text-red-600"/> Materi Kelas {userData.kelas}</h3>
        
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {myModules.length > 0 ? myModules.map(m => (
            <div key={m.id} onClick={() => { setSelectedModule(m); setView('detail'); }} className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-red-500 hover:shadow-xl cursor-pointer transition-all group relative overflow-hidden">
               <div className="absolute top-0 right-0 bg-slate-100 text-slate-500 text-[10px] font-bold px-3 py-1 rounded-bl-xl uppercase tracking-wider group-hover:bg-red-500 group-hover:text-white transition-colors">
                 {m.durasi} Menit
               </div>
               <div className="mt-4 mb-4">
                 <h4 className="font-bold text-lg text-slate-800 group-hover:text-red-600 transition-colors line-clamp-2">{m.title}</h4>
               </div>
               <div className="flex items-center justify-between mt-auto pt-4 border-t border-slate-50">
                 <span className="text-xs font-bold text-slate-400">Modul Pembelajaran</span>
                 <div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-red-500 group-hover:text-white transition-all">
                   <ChevronLeft className="rotate-180" size={16}/>
                 </div>
               </div>
            </div>
          )) : (
            <div className="col-span-full py-12 text-center bg-white rounded-2xl border border-dashed">
              <p className="text-slate-400 font-bold">Belum ada materi untuk kelas {userData.kelas}</p>
            </div>
          )}
        </div>
      </Layout>
    );
  }

  // --- DETAIL MODUL ---
  if (view === 'detail' && selectedModule) {
    return (
      <Layout>
        <button onClick={() => setView('dashboard')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors">
           <ChevronLeft size={20}/> Kembali
        </button>
        
        <div className="bg-white rounded-3xl overflow-hidden shadow-xl border border-slate-100">
          <div className="bg-slate-900 text-white p-8">
            <div className="flex items-center gap-2 mb-2 opacity-70 text-sm font-bold uppercase tracking-wider">
              <Book size={14}/> Materi Kelas {selectedModule.kelas}
            </div>
            <h1 className="text-3xl md:text-4xl font-black">{selectedModule.title}</h1>
          </div>
          
          <div className="p-8">
            <div className="prose prose-slate max-w-none mb-12">
               <p className="text-lg leading-relaxed text-slate-600">{selectedModule.konten}</p>
            </div>
            
            <div className="flex justify-center">
              <button onClick={() => handleStartQuiz(selectedModule.id)} className="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-red-500/30 transition-all active:scale-95 flex items-center gap-2">
                ‚úçÔ∏è Kerjakan Kuis Evaluasi
              </button>
            </div>
          </div>
        </div>
      </Layout>
    );
  }

  // --- QUIZ VIEW ---
  if (view === 'quiz') {
    const q = quizState.questions[quizState.idx];
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans">
        <div className="bg-white w-full max-w-lg rounded-3xl p-8 relative">
           <div className="absolute top-0 left-0 w-full h-1 bg-slate-100 rounded-t-3xl overflow-hidden">
             <div className="h-full bg-red-500 transition-all duration-500" style={{width: `${((quizState.idx + 1) / quizState.questions.length) * 100}%`}}></div>
           </div>
           
           <div className="flex justify-between items-center mb-6 mt-2">
             <span className="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">SOAL {quizState.idx + 1} / {quizState.questions.length}</span>
             <span className="text-xs font-bold text-red-500">PANCASILA ACADEMY</span>
           </div>
           
           <h3 className="text-xl font-bold mb-8 text-slate-800 leading-snug">{q.q}</h3>
           
           <div className="space-y-3">
             {q.opt.map((opt, i) => (
               <button key={i} onClick={() => handleAnswer(i)} className="w-full text-left p-4 rounded-xl border-2 border-slate-100 font-bold text-slate-600 hover:border-red-500 hover:bg-red-50 hover:text-red-700 transition-all flex items-center gap-3 group">
                 <div className="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center text-sm group-hover:bg-red-500 group-hover:text-white transition-colors">{String.fromCharCode(65+i)}</div>
                 {opt}
               </button>
             ))}
           </div>
        </div>
      </div>
    );
  }

  // --- RESULT VIEW ---
  if (view === 'result') {
    const passed = quizState.finalScore >= 70;
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-center">
        <div className="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden">
           <div className={`absolute top-0 left-0 w-full h-32 ${passed ? 'bg-green-500' : 'bg-red-500'}`}></div>
           
           <div className="relative z-10 bg-white w-24 h-24 mx-auto rounded-full flex items-center justify-center text-5xl shadow-xl mt-12 mb-6">
             {passed ? 'üèÜ' : 'üìö'}
           </div>
           
           <h2 className="text-slate-800 text-4xl font-black mb-1">{quizState.finalScore}</h2>
           <p className="text-slate-400 font-bold text-sm uppercase tracking-wider mb-8">{passed ? 'Lulus Kompetensi' : 'Perlu Belajar Lagi'}</p>
           
           <div className="bg-slate-50 rounded-xl p-4 mb-6 text-sm text-slate-500">
             {passed ? "Kerja bagus! Baginda Raja pasti bangga." : "Jangan menyerah, coba baca materi sekali lagi."}
           </div>

           <button onClick={() => setView('dashboard')} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 shadow-lg">
             Kembali ke Dashboard
           </button>
        </div>
      </div>
    );
  }

  return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400 font-bold">Memuat Aplikasi...</div>;
};

export default App;
