<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pancasila Academy</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS untuk Membaca Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Babel untuk memproses JSX di browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Animation Utility */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* LOADER CSS (Murni CSS agar ringan & cepat muncul) */
        .initial-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f8fafc; /* Slate-50 */
            color: #475569; /* Slate-600 */
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0; /* Slate-200 */
            border-top: 5px solid #dc2626; /* Red-600 */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-weight: 600; font-size: 0.9rem; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">
    <!-- 
      DIV ROOT dengan KONTEN STATIS (Pre-loader).
      Konten ini akan terlihat LANGSUNG saat file dibuka, 
      dan akan otomatis hilang/tertimpa saat React selesai memuat.
    -->
    <div id="root">
        <div class="initial-loader">
            <div class="spinner"></div>
            <div class="loading-text">Sedang Menyiapkan Pancasila Academy...</div>
            <div style="font-size: 0.75rem; margin-top: 10px; color: #94a3b8;">Mohon tunggu sebentar Baginda...</div>
        </div>
    </div>

    <!-- Script Utama dengan Tipe Module -->
    <script type="text/babel" data-type="module">
        // --- IMPORTS DARI CDN (ESM) ---
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Firebase Modular SDK
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, onSnapshot, query, updateDoc, deleteDoc, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // Lucide React Icons
        import { Book, User, Award, LogOut, Plus, Trash2, CheckCircle, XCircle, ChevronLeft, ChevronDown, Shield, Search, Filter, FileText, Download, Pencil, Eye, Users, ClipboardList, LayoutGrid, Key, X, Edit, RefreshCw, Upload } from 'https://esm.sh/lucide-react@0.344.0';

        // ==============================================================================
        // ‚ö†Ô∏è KONFIGURASI FIREBASE (SUDAH DIPERBARUI BAGINDA) ‚ö†Ô∏è
        // ==============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBlR-H_LQXpUwEX322FGjH4o7n0HxscOpM",
            authDomain: "pancasila-academy.firebaseapp.com",
            projectId: "pancasila-academy",
            storageBucket: "pancasila-academy.firebasestorage.app",
            messagingSenderId: "393704415387",
            appId: "1:393704415387:web:8d0658514e272b5121663e"
        };
        
        const appId = 'pancasila-academy-v1';
        // ==============================================================================

        // Inisialisasi Variabel Global
        let app, auth, db;
        let isConfigured = true;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (err) {
            console.error("Firebase Error:", err);
            isConfigured = false;
        }

        // --- DATA MODUL DEFAULT ---
        const defaultModules = [
          { 
            id: 'sejarah-pancasila', 
            title: 'Sejarah Perumusan Pancasila', 
            kelas: 'X', 
            durasi: '45', 
            konten: 'Sidang BPUPKI pertama membahas dasar negara. Tokoh yang mengusulkan antara lain M. Yamin, Soepomo, dan Soekarno. Kemudian terbentuklah Piagam Jakarta sebagai kesepakatan awal.' 
          },
          { 
            id: 'demokrasi-indonesia', 
            title: 'Dinamika Demokrasi', 
            kelas: 'XI', 
            durasi: '60', 
            konten: 'Demokrasi di Indonesia mengalami pasang surut, mulai dari Demokrasi Parlementer, Terpimpin, hingga Demokrasi Pancasila. Intinya adalah kedaulatan berada di tangan rakyat.' 
          },
          { 
            id: 'pelanggaran-hak', 
            title: 'Pelanggaran Hak & Kewajiban', 
            kelas: 'XII', 
            durasi: '50', 
            konten: 'Pelanggaran hak warga negara terjadi ketika warga negara tidak dapat menikmati atau memperoleh haknya. Faktor penyebabnya bisa internal (egoisme) atau eksternal (penyalahgunaan kekuasaan).' 
          }
        ];

        // --- DATA KUIS ---
        const quizDatabase = {
          'sejarah-pancasila': [
            { q: 'Siapa yang mengusulkan nama Pancasila?', opt: ['M. Yamin', 'Soepomo', 'Ir. Soekarno', 'Hatta'], ans: 2 },
            { q: 'Kapan hari lahir Pancasila diperingati?', opt: ['1 Juni', '17 Agustus', '18 Agustus', '22 Juni'], ans: 0 }
          ],
          'demokrasi-indonesia': [
            { q: 'Kedaulatan berada di tangan...', opt: ['Presiden', 'DPR', 'Rakyat', 'MPR'], ans: 2 },
            { q: 'Demokrasi Pancasila mengutamakan...', opt: ['Voting', 'Musyawarah', 'Otoriter', 'Liberal'], ans: 1 }
          ],
          'pelanggaran-hak': [
            { q: 'Membuang sampah sembarangan melanggar...', opt: ['Hak', 'Kewajiban', 'Hukum Pidana', 'Adat'], ans: 1 },
            { q: 'Faktor internal pelanggaran hak adalah...', opt: ['Aparat lemah', 'Sikap egois', 'Teknologi', 'Kesenjangan'], ans: 1 }
          ]
        };

        // --- KOMPONEN LAYOUT ---
        const Layout = ({ children, notification, userData, handleLogout }) => (
            <div className="min-h-screen bg-slate-50 pb-20 font-sans text-slate-700 fade-in flex flex-col justify-between">
                <div>
                    {notification && (
                        <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-xl font-bold text-white flex items-center gap-2 animate-bounce ${notification.type==='error'?'bg-red-500':'bg-green-500'}`}>
                            {notification.type === 'error' ? <XCircle/> : <CheckCircle/>} {notification.msg}
                        </div>
                    )}
                    <nav className="bg-white px-4 py-3 border-b sticky top-0 z-20 shadow-sm flex justify-between items-center">
                        <div className="flex items-center gap-2 font-black text-slate-700 text-lg">
                            <Shield className="text-red-600 fill-current" /> 
                            <span className="hidden sm:inline">PANCASILA ACADEMY</span>
                            <span className="sm:hidden">PANCASILA</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right hidden sm:block">
                                <div className="font-bold text-sm leading-tight">{userData?.name}</div>
                                <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-100 px-2 py-0.5 rounded-full inline-block">{userData?.role}</div>
                            </div>
                            <button onClick={handleLogout} className="p-2 bg-red-50 text-red-500 rounded-full hover:bg-red-100 transition-colors">
                                <LogOut size={18} />
                            </button>
                        </div>
                    </nav>
                    <main className="max-w-4xl mx-auto p-4 mt-2">{children}</main>
                </div>

                <footer className="text-center py-8 text-xs text-slate-400">
                    <p>Dikembangkan Oleh:</p>
                    <p className="font-bold text-slate-500">Mohamad Dezan Hadiansyah, S.H., Gr.</p>
                    <p>Guru Pendidikan Pancasila SMK Al-Wafa</p>
                </footer>
            </div>
        );

        // --- KOMPONEN UTAMA ---
        const App = () => {
            const [loadingState, setLoadingState] = useState(true);
            const [loadingTooLong, setLoadingTooLong] = useState(false);
            const fileInputRef = useRef(null);

            if (!isConfigured) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 text-slate-600 p-4">
                        <div className="max-w-md text-center space-y-4">
                            <h1 className="text-4xl font-black text-red-500">‚ö†Ô∏è ERROR</h1>
                            <p className="text-lg">Gagal menghubungkan ke Firebase.</p>
                        </div>
                    </div>
                );
            }

            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [view, setView] = useState('login');
            const [error, setError] = useState('');
            const [notification, setNotification] = useState(null);
            const [modules, setModules] = useState([]);
            const [selectedModule, setSelectedModule] = useState(null);
            const [students, setStudents] = useState([]);
            
            // State Lainnya...
            const [searchTerm, setSearchTerm] = useState('');
            const [filterClass, setFilterClass] = useState('Semua');
            const [selectedStudent, setSelectedStudent] = useState(null); 
            const [authMode, setAuthMode] = useState('siswa');
            const [form, setForm] = useState({ username: '', password: '', fullname: '', kelas: 'X', jurusan: 'ULP', teacherCode: '' });
            const [quizState, setQuizState] = useState({ idx: 0, correct: 0, answers: [] });
            const [teacherTab, setTeacherTab] = useState('menu'); 
            const [newMateri, setNewMateri] = useState({ title: '', kelas: 'X', durasi: '', konten: '' });
            const [editingId, setEditingId] = useState(null); 
            const [studentModalOpen, setStudentModalOpen] = useState(false);
            const [editingStudentId, setEditingStudentId] = useState(null);
            const [studentForm, setStudentForm] = useState({ name: '', username: '', password: '', kelas: 'X', jurusan: 'ULP' });

            // --- INIT AUTH & DATA ---
            useEffect(() => {
                // Timeout logic jika loading terlalu lama
                const timer = setTimeout(() => {
                    if (loadingState) setLoadingTooLong(true);
                }, 10000);

                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setError("Gagal inisialisasi Auth.");
                    }
                };
                if(auth) initAuth();

                const unsubscribe = auth ? onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoadingState(false); // Auth selesai, matikan loading
                    if (!u) {
                        setUserData(null);
                        setView('login');
                    }
                }) : () => {};
                
                return () => {
                    unsubscribe();
                    clearTimeout(timer);
                };
            }, []);

            // --- FETCH DATA ---
            useEffect(() => {
                if (!user || !db) return;
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
                const unsubUser = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setUserData(docSnap.data());
                        setView('dashboard');
                    }
                }, (err) => console.error("Err fetch user:", err));
                return () => unsubUser();
            }, [user]);

            useEffect(() => {
                if(!user || !db) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'modules'));
                const unsub = onSnapshot(q, (snap) => {
                    const fetched = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    const combined = [...defaultModules.filter(dm => !fetched.find(f => f.id === dm.id)), ...fetched];
                    setModules(combined);
                }, (err) => console.log("Err modules", err)); 
                return () => unsub();
            }, [user]);

            useEffect(() => {
                if(!user || !userData || userData.role !== 'guru' || !db) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('role', '==', 'siswa'));
                const unsub = onSnapshot(q, (snap) => {
                    setStudents(snap.docs.map(d => ({id: d.id, ...d.data()})));
                }, (err) => console.log("Err students", err));
                return () => unsub();
            }, [user, userData]);


            // --- HANDLERS ---
            const showNotif = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    setUser(null);
                    setUserData(null);
                    setView('login');
                    setTeacherTab('menu');
                } catch (error) {
                    console.error("Logout Error:", error);
                    showNotif("Gagal Logout", "error");
                }
            };

            // FITUR BARU: IMPORT/EXPORT EXCEL
            const handleDownloadTemplate = () => {
                // Membuat data dummy untuk template
                const templateData = [
                    { "Nama Lengkap": "Budi Santoso", "Username": "budi01", "Password": "123", "Kelas": "X", "Jurusan": "ULP" },
                    { "Nama Lengkap": "Siti Aminah", "Username": "siti02", "Password": "123", "Kelas": "XI", "Jurusan": "PF" }
                ];
                // Menggunakan SheetJS untuk membuat workbook
                const ws = XLSX.utils.json_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Template Siswa");
                // Download file Excel
                XLSX.writeFile(wb, "Template_Import_Siswa.xlsx");
            };

            const handleImportSiswa = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    let successCount = 0;
                    for (const row of jsonData) {
                        // Membaca data berdasarkan header di Excel
                        const name = row['Nama Lengkap'];
                        const username = row['Username'];
                        // Default password jika kosong: 123456
                        const password = row['Password'] ? String(row['Password']) : '123456';
                        const kelas = row['Kelas'] || 'X';
                        const jurusan = row['Jurusan'] || 'ULP';

                        if (name && username) {
                            const newId = 'student_' + Date.now() + Math.random().toString(36).substr(2, 5);
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', newId), {
                                name, username, password, kelas, jurusan,
                                role: 'siswa',
                                createdAt: new Date().toISOString(),
                                scores: {}
                            });
                            successCount++;
                        }
                    }
                    showNotif(`Berhasil mengimport ${successCount} siswa!`, "success");
                } catch (err) {
                    console.error("Import Error:", err);
                    showNotif("Gagal membaca file Excel. Pastikan format benar.", "error");
                }
                
                // Reset input file agar bisa digunakan lagi
                if(fileInputRef.current) fileInputRef.current.value = "";
            };

            const handleRegister = async () => {
                if (!form.username || !form.password || !form.fullname) return setError("Semua kolom wajib diisi!");
                if (authMode === 'guru' && form.teacherCode !== 'PANCA2024') return setError("Kode Guru Salah!");

                try {
                    const role = authMode;
                    const newUser = {
                        username: form.username,
                        password: form.password, 
                        name: form.fullname,
                        role: role,
                        createdAt: new Date().toISOString(),
                        scores: {}
                    };
                    if (role === 'siswa') {
                        newUser.kelas = form.kelas;
                        newUser.jurusan = form.jurusan;
                    }
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid), newUser);
                    showNotif("Pendaftaran Berhasil!", "success");
                } catch (e) {
                    setError(e.message);
                }
            };

            const handleLogin = async () => {
                try {
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                        where('username', '==', form.username),
                        where('password', '==', form.password),
                        where('role', '==', authMode)
                    );
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        setError("Login Gagal. Cek username/password/peran.");
                    } else {
                        const foundUser = querySnapshot.docs[0].data();
                        setUserData(foundUser);
                        setView('dashboard');
                    }
                } catch (e) {
                    console.error(e);
                    setError("Terjadi kesalahan koneksi atau database belum siap.");
                }
            };

            const handleSaveMateri = async () => {
                if (!newMateri.title || !newMateri.konten) return showNotif("Judul & Konten wajib diisi", "error");
                try {
                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'modules', editingId), { ...newMateri });
                        showNotif("Materi Berhasil Diupdate!", "success");
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'modules'), { ...newMateri, createdAt: new Date().toISOString() });
                        showNotif("Materi Berhasil Disimpan!", "success");
                    }
                    setNewMateri({ title: '', kelas: 'X', durasi: '', konten: '' });
                    setEditingId(null);
                    setTeacherTab('modul');
                    setView('dashboard');
                } catch (e) {
                    showNotif("Gagal menyimpan: " + e.message, "error");
                }
            };

            const handleDeleteModul = async (id) => {
                if(!confirm("Baginda yakin ingin menghapus modul ini?")) return;
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'modules', id)); showNotif("Modul berhasil dihapus"); } 
                catch(e) { showNotif("Gagal menghapus modul", "error"); }
            };

            const handleEditModul = (modul) => {
                setNewMateri({ title: modul.title, kelas: modul.kelas, durasi: modul.durasi.toString().replace(' Menit',''), konten: modul.konten });
                setEditingId(modul.id);
                setView('addMateri');
            };

            const openAddStudentModal = () => { setEditingStudentId(null); setStudentForm({ name: '', username: '', password: '123', kelas: 'X', jurusan: 'ULP' }); setStudentModalOpen(true); };
            const openEditStudentModal = (student) => { setEditingStudentId(student.id); setStudentForm({ name: student.name, username: student.username, password: student.password, kelas: student.kelas, jurusan: student.jurusan }); setStudentModalOpen(true); };

            const handleSaveStudent = async () => {
                if (!studentForm.name || !studentForm.username) return showNotif("Nama & Username wajib diisi", "error");
                try {
                    const studentData = { ...studentForm, role: 'siswa' };
                    if (editingStudentId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingStudentId), studentData);
                        showNotif("Data siswa berhasil diperbarui", "success");
                    } else {
                        const newId = 'student_' + Date.now();
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', newId), { ...studentData, createdAt: new Date().toISOString(), scores: {} });
                        showNotif("Siswa baru berhasil ditambahkan", "success");
                    }
                    setStudentModalOpen(false);
                } catch (e) { showNotif("Gagal menyimpan: " + e.message, "error"); }
            };

            const handleResetPassword = async (id) => {
                if (!confirm("Reset password siswa ini menjadi '123456'?")) return;
                try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { password: '123456' }); showNotif("Password berhasil direset ke '123456'", "success"); } 
                catch (e) { showNotif("Gagal reset password", "error"); }
            };

            const handleDeleteSiswa = async (id) => {
                if(!confirm("Yakin hapus siswa ini Baginda? Data tidak bisa dikembalikan.")) return;
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id)); showNotif("Data siswa dihapus"); } 
                catch(e) { showNotif("Gagal menghapus", "error"); }
            };

            const handleDownloadCSV = () => {
                const header = "Nama Lengkap,Kelas,Jurusan,Rata-rata Nilai,Detail Nilai (Modul:Skor)\n";
                const rows = students.map(s => {
                    const avg = s.scores && Object.values(s.scores).length > 0 ? Math.round(Object.values(s.scores).reduce((a,b)=>a+b,0)/Object.values(s.scores).length) : 0;
                    const detailScores = s.scores ? Object.entries(s.scores).map(([k,v]) => { const modName = modules.find(m => m.id === k)?.title || k; return `${modName}:${v}`; }).join(" | ") : "-";
                    return `"${s.name}","${s.kelas}","${s.jurusan}","${avg}","${detailScores}"`;
                }).join("\n");
                const csvContent = "data:text/csv;charset=utf-8," + header + rows;
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "rekap_nilai_pancasila_academy.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleStartQuiz = (modulId) => {
                const soal = quizDatabase[modulId] || quizDatabase['sejarah-pancasila'];
                setQuizState({ modulId, idx: 0, correct: 0, answers: [], questions: soal });
                setView('quiz');
            };

            const handleAnswer = async (ansIdx) => {
                const isCorrect = ansIdx === quizState.questions[quizState.idx].ans;
                const newCorrect = isCorrect ? quizState.correct + 1 : quizState.correct;
                if (quizState.idx + 1 < quizState.questions.length) {
                    setQuizState({ ...quizState, idx: quizState.idx + 1, correct: newCorrect });
                } else {
                    const finalScore = Math.round((newCorrect / quizState.questions.length) * 100);
                    if (userData && userData.role === 'siswa') {
                        try {
                            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), where('username', '==', userData.username));
                            const snaps = await getDocs(q);
                            if(!snaps.empty) {
                                const docId = snaps.docs[0].id;
                                const currentScores = snaps.docs[0].data().scores || {};
                                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', docId), { scores: { ...currentScores, [quizState.modulId]: finalScore } });
                            }
                        } catch(e) { console.error("Gagal save score", e); }
                    }
                    setQuizState({ ...quizState, finalScore });
                    setView('result');
                }
            };

            const filteredStudents = useMemo(() => {
                return students.filter(s => {
                    const matchName = s.name.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchClass = filterClass === 'Semua' || s.kelas === filterClass;
                    return matchName && matchClass;
                });
            }, [students, searchTerm, filterClass]);

            // --- LOADING SCREEN ---
            if (loadingState) {
                if (loadingTooLong) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 text-slate-600 p-4 font-sans text-center fade-in">
                            <XCircle size={48} className="text-red-500 mb-4"/>
                            <h2 className="text-xl font-bold mb-2">Koneksi Lambat</h2>
                            <p className="text-sm mb-6">Mencoba menghubungkan ke server...</p>
                            <button onClick={()=>window.location.reload()} className="px-6 py-2 bg-slate-800 text-white rounded-full font-bold hover:bg-slate-700 flex items-center gap-2">
                                <RefreshCw size={16}/> Muat Ulang Halaman
                            </button>
                        </div>
                    )
                }
                return null;
            }

            // --- TAMPILAN: LOGIN / REGISTER ---
            if (view === 'login' || view === 'register') {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-200 to-slate-100 p-4 font-sans text-slate-700">
                        <div className="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl relative overflow-hidden fade-in">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 to-white"></div>
                            <h1 className="text-3xl font-black text-center mb-2 tracking-tight text-slate-700">PANCASILA<br/><span className="text-red-600">ACADEMY</span></h1>
                            <p className="text-center text-slate-500 mb-6 text-sm">Platform Pembelajaran Ideologi Bangsa</p>

                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-xl mb-4 text-sm font-semibold flex items-center gap-2"><XCircle size={16}/> {error}</div>}
                            {notification && <div className="bg-green-50 text-green-600 p-3 rounded-xl mb-4 text-sm font-semibold flex items-center gap-2"><CheckCircle size={16}/> {notification.msg}</div>}

                            <div className="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
                                <button onClick={() => setAuthMode('siswa')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${authMode === 'siswa' ? 'bg-white shadow text-slate-700' : 'text-slate-400 hover:text-slate-600'}`}>üéì Siswa</button>
                                <button onClick={() => setAuthMode('guru')} className={`flex-1 py-2 rounded-lg font-bold text-sm transition-all ${authMode === 'guru' ? 'bg-white shadow text-slate-700' : 'text-slate-400 hover:text-slate-600'}`}>üíº Guru</button>
                            </div>

                            <div className="space-y-3">
                                {view === 'register' && (
                                    <>
                                        <input value={form.fullname} onChange={e=>setForm({...form, fullname: e.target.value})} placeholder="Nama Lengkap" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 transition-all" />
                                        {authMode === 'siswa' ? (
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="relative">
                                                    <select value={form.kelas} onChange={e=>setForm({...form, kelas: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none font-bold text-slate-600">
                                                        <option value="X">Kelas X</option>
                                                        <option value="XI">Kelas XI</option>
                                                        <option value="XII">Kelas XII</option>
                                                    </select>
                                                    <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} />
                                                </div>
                                                <div className="relative">
                                                    <select value={form.jurusan} onChange={e=>setForm({...form, jurusan: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none font-bold text-slate-600">
                                                        <option value="ULP">ULP</option>
                                                        <option value="PF">PF</option>
                                                        <option value="TF">TF</option>
                                                    </select>
                                                    <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} />
                                                </div>
                                            </div>
                                        ) : (
                                            <input type="password" value={form.teacherCode} onChange={e=>setForm({...form, teacherCode: e.target.value})} placeholder="Kode Guru (PANCA2024)" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />
                                        )}
                                    </>
                                )}
                                <input value={form.username} onChange={e=>setForm({...form, username: e.target.value})} placeholder="Username" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />
                                <input type="password" value={form.password} onChange={e=>setForm({...form, password: e.target.value})} placeholder="Password" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" />
                                
                                <button onClick={view === 'login' ? handleLogin : handleRegister} className="w-full bg-slate-600 text-white py-4 rounded-xl font-bold hover:bg-slate-700 transition-all shadow-lg active:scale-95 flex justify-center items-center gap-2">
                                    {view === 'login' ? 'Masuk Sekarang' : 'Daftar Akun'} <ChevronLeft className="rotate-180" size={18}/>
                                </button>
                            </div>

                            <p className="text-center mt-6 text-sm text-slate-400">
                                {view === 'login' ? 'Belum punya akun?' : 'Sudah punya akun?'} 
                                <span onClick={() => {setView(view === 'login' ? 'register' : 'login'); setError('')}} className="text-red-600 font-bold cursor-pointer ml-1 hover:underline">
                                    {view === 'login' ? 'Daftar' : 'Login'}
                                </span>
                            </p>

                            <div className="mt-8 pt-6 border-t border-slate-100 text-center text-xs text-slate-400 leading-relaxed">
                                <p>Dikembangkan Oleh:</p>
                                <p className="font-bold text-slate-500">Mohamad Dezan Hadiansyah, S.H., Gr.</p>
                                <p>Guru Pendidikan Pancasila SMK Al-Wafa</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- TAMPILAN: GURU DASHBOARD ---
            if (view === 'dashboard' && userData?.role === 'guru') {
                return (
                    <Layout notification={notification} userData={userData} handleLogout={handleLogout}>
                        <div className="bg-slate-600 text-white p-8 rounded-3xl mb-6 relative overflow-hidden shadow-xl">
                            <div className="relative z-10">
                                <h2 className="text-3xl font-bold mb-2">Panel Instruktur</h2>
                                <p className="text-slate-200">Selamat datang, Baginda {userData.name}.</p>
                            </div>
                            <div className="absolute -right-10 -bottom-20 text-9xl opacity-10 rotate-12">üë®‚Äçüè´</div>
                        </div>
                        {/* MENU UTAMA */}
                        {teacherTab === 'menu' && (
                            <div className="grid md:grid-cols-3 gap-6 animate-fadeIn">
                                <div onClick={() => setTeacherTab('modul')} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-blue-500 cursor-pointer transition-all group">
                                    <div className="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 mb-4 group-hover:scale-110 transition-transform"><Book size={28}/></div>
                                    <h3 className="text-xl font-bold text-slate-700 mb-2">Modul Pembelajaran</h3>
                                    <p className="text-sm text-slate-400">Tambah, edit, dan kelola materi ajar.</p>
                                </div>
                                <div onClick={() => setTeacherTab('siswa')} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-orange-500 cursor-pointer transition-all group">
                                    <div className="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center text-orange-600 mb-4 group-hover:scale-110 transition-transform"><Users size={28}/></div>
                                    <h3 className="text-xl font-bold text-slate-700 mb-2">Data Siswa</h3>
                                    <p className="text-sm text-slate-400">Pantau dan kelola akun siswa.</p>
                                </div>
                                <div onClick={() => setTeacherTab('rekap')} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-green-500 cursor-pointer transition-all group">
                                    <div className="w-14 h-14 bg-green-100 rounded-2xl flex items-center justify-center text-green-600 mb-4 group-hover:scale-110 transition-transform"><ClipboardList size={28}/></div>
                                    <h3 className="text-xl font-bold text-slate-700 mb-2">Rekap Nilai</h3>
                                    <p className="text-sm text-slate-400">Lihat analisis nilai dan unduh laporan.</p>
                                </div>
                            </div>
                        )}
                        {/* SUB-MENU: MODUL */}
                        {teacherTab === 'modul' && (
                            <div className="animate-fadeIn">
                                <button onClick={() => setTeacherTab('menu')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors"><ChevronLeft size={20}/> Kembali ke Menu</button>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-2xl flex items-center gap-2 text-slate-700"><Book className="text-blue-600"/> Manajemen Modul</h3>
                                    <button onClick={() => { setEditingId(null); setNewMateri({ title: '', kelas: 'X', durasi: '', konten: '' }); setView('addMateri'); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-blue-700 shadow-lg"><Plus size={16}/> Tambah Modul</button>
                                </div>
                                <div className="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 text-slate-500 font-bold uppercase"><tr><th className="p-4">Judul</th><th className="p-4">Kelas</th><th className="p-4">Durasi</th><th className="p-4 text-center">Aksi</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {modules.map(m => (<tr key={m.id} className="hover:bg-slate-50"><td className="p-4 font-bold text-slate-700">{m.title}</td><td className="p-4"><span className="bg-slate-100 px-2 py-1 rounded text-xs font-bold text-slate-500">{m.kelas}</span></td><td className="p-4">{m.durasi} Menit</td><td className="p-4 flex justify-center gap-2"><button onClick={() => handleEditModul(m)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-full"><Pencil size={16}/></button><button onClick={() => handleDeleteModul(m.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-full"><Trash2 size={16}/></button></td></tr>))}
                                            {modules.length === 0 && <tr><td colSpan="4" className="p-4 text-center text-slate-400 italic">Belum ada modul.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        {/* SUB-MENU: SISWA */}
                        {teacherTab === 'siswa' && (
                            <div className="animate-fadeIn">
                                <button onClick={() => setTeacherTab('menu')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors"><ChevronLeft size={20}/> Kembali ke Menu</button>
                                <div className="flex flex-col gap-4 mb-6">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                        <div><h3 className="font-bold text-2xl flex items-center gap-2 text-slate-700"><Users className="text-orange-600"/> Data Siswa</h3><div className="text-sm text-slate-400 mt-1">Total: {students.length} Siswa Terdaftar</div></div>
                                        <div className="flex gap-2">
                                            <button onClick={handleDownloadTemplate} className="bg-white border border-green-600 text-green-600 px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-green-50 shadow-sm"><Download size={16}/> Unduh Template</button>
                                            <div className="relative">
                                                <input type="file" accept=".xlsx, .xls, .csv" ref={fileInputRef} onChange={handleImportSiswa} className="hidden" />
                                                <button onClick={() => fileInputRef.current.click()} className="bg-blue-600 text-white px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-blue-700 shadow-lg"><Upload size={16}/> Import Excel</button>
                                            </div>
                                            <button onClick={openAddStudentModal} className="bg-orange-600 text-white px-3 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-orange-700 shadow-lg"><Plus size={16}/> Tambah</button>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200 mb-4 flex flex-col md:flex-row gap-3 shadow-sm">
                                    <div className="flex-1 relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input type="text" placeholder="Cari nama siswa..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                    <div className="w-full md:w-48 relative"><div className="relative"><select className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-400 appearance-none font-bold text-slate-600" value={filterClass} onChange={(e) => setFilterClass(e.target.value)}><option value="Semua">Semua Kelas</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select><Filter className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} /></div></div>
                                </div>
                                <div className="space-y-3">
                                    {filteredStudents.map(s => (<div key={s.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row justify-between items-center hover:shadow-md transition-shadow gap-4"><div className="flex items-center gap-4 w-full md:w-auto"><div className="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold shrink-0">{s.name.charAt(0)}</div><div><div className="font-bold text-slate-700">{s.name}</div><div className="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-0.5 rounded inline-block mt-1">{s.kelas} - {s.jurusan} <span className="mx-1 text-slate-300">|</span> <span className="italic">{s.username}</span></div></div></div><div className="flex gap-2"><button onClick={() => openEditStudentModal(s)} className="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-blue-100" title="Edit"><Edit size={14}/> Edit</button><button onClick={() => handleResetPassword(s.id)} className="px-3 py-2 bg-yellow-50 text-yellow-600 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-yellow-100" title="Reset Pass"><Key size={14}/> Reset</button><button onClick={() => handleDeleteSiswa(s.id)} className="px-3 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold flex items-center gap-1 hover:bg-red-100" title="Hapus"><Trash2 size={14}/> Hapus</button></div></div>))}
                                    {filteredStudents.length === 0 && <div className="text-center py-10 text-slate-400 italic bg-slate-50 rounded-xl border border-dashed">Tidak ada siswa.</div>}
                                </div>
                            </div>
                        )}
                        {/* SUB-MENU: REKAP */}
                        {teacherTab === 'rekap' && (
                            <div className="animate-fadeIn">
                                <button onClick={() => setTeacherTab('menu')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors"><ChevronLeft size={20}/> Kembali ke Menu</button>
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><h3 className="font-bold text-2xl flex items-center gap-2 text-slate-700"><ClipboardList className="text-green-600"/> Rekap Nilai</h3><button onClick={handleDownloadCSV} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 hover:bg-green-700 shadow-sm"><Download size={16}/> Unduh CSV</button></div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200 mb-4 flex flex-col md:flex-row gap-3 shadow-sm">
                                    <div className="flex-1 relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input type="text" placeholder="Cari nama siswa..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                    <div className="w-full md:w-48 relative"><div className="relative"><select className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 appearance-none font-bold text-slate-600" value={filterClass} onChange={(e) => setFilterClass(e.target.value)}><option value="Semua">Semua Kelas</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select><Filter className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} /></div></div>
                                </div>
                                <div className="space-y-3">
                                    {filteredStudents.map(s => (<div key={s.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow"><div className="flex items-center gap-4"><div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 font-bold">{s.name.charAt(0)}</div><div><div className="font-bold text-slate-700">{s.name}</div><div className="text-xs text-slate-500 font-medium bg-slate-100 px-2 py-0.5 rounded inline-block mt-1">{s.kelas} - {s.jurusan}</div></div></div><div className="flex items-center gap-4"><div className="text-right"><div className="text-[10px] text-slate-400 font-bold uppercase">Rata-rata</div><div className="font-bold text-lg text-slate-700">{s.scores && Object.values(s.scores).length > 0 ? Math.round(Object.values(s.scores).reduce((a,b)=>a+b,0)/Object.values(s.scores).length) : '-'}</div></div><button onClick={() => { setSelectedStudent(s); setView('studentDetail'); }} className="p-2 text-slate-400 hover:bg-slate-100 rounded-full"><Eye size={18}/></button></div></div>))}
                                </div>
                            </div>
                        )}
                        {/* MODAL SISWA */}
                        {studentModalOpen && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fadeIn">
                                <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
                                    <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                                        <h3 className="font-bold text-lg text-slate-800">{editingStudentId ? 'Edit Data Siswa' : 'Tambah Siswa Baru'}</h3>
                                        <button onClick={() => setStudentModalOpen(false)} className="text-slate-400 hover:text-red-500"><X size={20}/></button>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Nama Lengkap</label><input value={studentForm.name} onChange={e=>setStudentForm({...studentForm, name: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Nama Siswa" /></div>
                                        <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Username Login</label><input value={studentForm.username} onChange={e=>setStudentForm({...studentForm, username: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Username Unik" /></div>
                                        {!editingStudentId && <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Password Awal</label><input value={studentForm.password} onChange={e=>setStudentForm({...studentForm, password: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="Password" /><p className="text-[10px] text-slate-400 mt-1">*Default: 123</p></div>}
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Kelas</label><div className="relative"><select value={studentForm.kelas} onChange={e=>setStudentForm({...studentForm, kelas: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 appearance-none font-bold text-slate-600"><option disabled value="">Pilih</option><option value="X">Kelas X</option><option value="XI">Kelas XI</option><option value="XII">Kelas XII</option></select><ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} /></div></div>
                                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Jurusan</label><div className="relative"><select value={studentForm.jurusan} onChange={e=>setStudentForm({...studentForm, jurusan: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 appearance-none font-bold text-slate-600"><option disabled value="">Pilih</option><option value="ULP">ULP</option><option value="PF">PF</option><option value="TF">TF</option></select><ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} /></div></div>
                                        </div>
                                        <button onClick={handleSaveStudent} className="w-full py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 shadow-lg mt-2">{editingStudentId ? 'Simpan' : 'Tambah'}</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </Layout>
                );
            }

            // --- TAMPILAN: GURU ADD/EDIT MATERI ---
            if (view === 'addMateri') {
                return (
                    <Layout notification={notification} userData={userData} handleLogout={handleLogout}>
                        <button onClick={() => setView('dashboard')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors">
                            <ChevronLeft size={20}/> Kembali ke Dashboard
                        </button>
                        <div className="bg-white rounded-3xl p-8 shadow-xl border border-slate-100 max-w-2xl mx-auto">
                            <h2 className="text-2xl font-black text-slate-700 mb-6">{editingId ? 'Edit Materi' : 'Tulis Materi Baru'}</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Judul Modul</label>
                                    <input value={newMateri.title} onChange={e=>setNewMateri({...newMateri, title: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl border-2 border-transparent focus:border-red-500 focus:bg-white transition-all font-bold text-lg" placeholder="Contoh: Anti Korupsi" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Kelas</label>
                                        <div className="relative">
                                            <select value={newMateri.kelas} onChange={e=>setNewMateri({...newMateri, kelas: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none appearance-none">
                                                <option disabled value="">Pilih Kelas</option>
                                                <option value="X">Kelas X</option>
                                                <option value="XI">Kelas XI</option>
                                                <option value="XII">Kelas XII</option>
                                            </select>
                                            <ChevronDown className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={20} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Durasi (Menit)</label>
                                        <input type="number" value={newMateri.durasi} onChange={e=>setNewMateri({...newMateri, durasi: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none" placeholder="45" />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-1">Isi Materi</label>
                                    <textarea value={newMateri.konten} onChange={e=>setNewMateri({...newMateri, konten: e.target.value})} className="w-full p-4 bg-slate-50 rounded-xl border-2 border-transparent focus:border-red-500 focus:bg-white transition-all h-48 leading-relaxed" placeholder="Tuliskan konten materi pembelajaran di sini..."></textarea>
                                </div>
                                <button onClick={handleSaveMateri} className="w-full py-4 bg-slate-600 text-white rounded-xl font-bold hover:bg-slate-700 shadow-lg flex justify-center items-center gap-2 mt-4">
                                    <CheckCircle size={20}/> {editingId ? 'Update Materi' : 'Simpan Materi ke Database'}
                                </button>
                            </div>
                        </div>
                    </Layout>
                )
            }

            // --- TAMPILAN: SISWA DASHBOARD ---
            if (view === 'dashboard' && userData?.role === 'siswa') {
                const myModules = modules.filter(m => m.kelas === userData.kelas);
                return (
                    <Layout notification={notification} userData={userData} handleLogout={handleLogout}>
                        <div className="bg-gradient-to-r from-red-600 to-red-500 text-white p-8 rounded-3xl mb-8 relative overflow-hidden shadow-lg">
                            <div className="relative z-10">
                                <h2 className="text-3xl font-bold mb-1">Halo, {userData.name.split(' ')[0]}! üëã</h2>
                                <p className="opacity-90">Siap belajar Pancasila hari ini?</p>
                                <div className="mt-4 inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-lg text-sm font-bold">
                                    <Award size={16}/> Skor Kamu: {userData.scores ? Math.round(Object.values(userData.scores).reduce((a,b)=>a+b,0)/Object.values(userData.scores).length || 0) : 0}
                                </div>
                            </div>
                            <div className="absolute right-0 bottom-0 text-9xl opacity-20 transform translate-y-4">üáÆüá©</div>
                        </div>

                        <h3 className="font-bold text-xl mb-4 text-slate-700 flex items-center gap-2"><Book className="text-red-600"/> Materi Kelas {userData.kelas}</h3>
                        
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {myModules.length > 0 ? myModules.map(m => (
                                <div key={m.id} onClick={() => { setSelectedModule(m); setView('detail'); }} className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-red-500 hover:shadow-xl cursor-pointer transition-all group relative overflow-hidden">
                                    <div className="absolute top-0 right-0 bg-slate-100 text-slate-500 text-[10px] font-bold px-3 py-1 rounded-bl-xl uppercase tracking-wider group-hover:bg-red-500 group-hover:text-white transition-colors">
                                        {m.durasi} Menit
                                    </div>
                                    <div className="mt-4 mb-4">
                                        <h4 className="font-bold text-lg text-slate-700 group-hover:text-red-600 transition-colors line-clamp-2">{m.title}</h4>
                                    </div>
                                    <div className="flex items-center justify-between mt-auto pt-4 border-t border-slate-50">
                                        <span className="text-xs font-bold text-slate-400">Modul Pembelajaran</span>
                                        <div className="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-red-500 group-hover:text-white transition-all">
                                            <ChevronLeft className="rotate-180" size={16}/>
                                        </div>
                                    </div>
                                </div>
                            )) : (
                                <div className="col-span-full py-12 text-center bg-white rounded-2xl border border-dashed">
                                    <p className="text-slate-400 font-bold">Belum ada materi untuk kelas {userData.kelas}</p>
                                </div>
                            )}
                        </div>
                    </Layout>
                );
            }

            // --- TAMPILAN: DETAIL MODUL ---
            if (view === 'detail' && selectedModule) {
                return (
                    <Layout notification={notification} userData={userData} handleLogout={handleLogout}>
                        <button onClick={() => setView('dashboard')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors">
                            <ChevronLeft size={20}/> Kembali
                        </button>
                        <div className="bg-white rounded-3xl overflow-hidden shadow-xl border border-slate-100">
                            {/* HEADER MODUL SOFT GREY */}
                            <div className="bg-slate-600 text-white p-8">
                                <div className="flex items-center gap-2 mb-2 opacity-70 text-sm font-bold uppercase tracking-wider">
                                    <Book size={14}/> Materi Kelas {selectedModule.kelas}
                                </div>
                                <h1 className="text-3xl md:text-4xl font-black">{selectedModule.title}</h1>
                            </div>
                            <div className="p-8">
                                <div className="prose prose-slate max-w-none mb-12">
                                    <p className="text-lg leading-relaxed text-slate-600">{selectedModule.konten}</p>
                                </div>
                                <div className="flex justify-center">
                                    <button onClick={() => handleStartQuiz(selectedModule.id)} className="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-full font-bold text-lg shadow-lg hover:shadow-red-500/30 transition-all active:scale-95 flex items-center gap-2">
                                        ‚úçÔ∏è Kerjakan Kuis Evaluasi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </Layout>
                );
            }

            // --- TAMPILAN: QUIZ ---
            if (view === 'quiz') {
                const q = quizState.questions[quizState.idx];
                return (
                    // BACKGROUND SOFT GREY (SLATE-100)
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans fade-in">
                        <div className="bg-white w-full max-w-lg rounded-3xl p-8 relative shadow-xl">
                            <div className="absolute top-0 left-0 w-full h-1 bg-slate-100 rounded-t-3xl overflow-hidden">
                                <div className="h-full bg-red-500 transition-all duration-500" style={{width: `${((quizState.idx + 1) / quizState.questions.length) * 100}%`}}></div>
                            </div>
                            <div className="flex justify-between items-center mb-6 mt-2">
                                <span className="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">SOAL {quizState.idx + 1} / {quizState.questions.length}</span>
                                <span className="text-xs font-bold text-red-500">PANCASILA ACADEMY</span>
                            </div>
                            <h3 className="text-xl font-bold mb-8 text-slate-700 leading-snug">{q.q}</h3>
                            <div className="space-y-3">
                                {q.opt.map((opt, i) => (
                                    <button key={i} onClick={() => handleAnswer(i)} className="w-full text-left p-4 rounded-xl border-2 border-slate-100 font-bold text-slate-600 hover:border-red-500 hover:bg-red-50 hover:text-red-700 transition-all flex items-center gap-3 group">
                                        <div className="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 flex items-center justify-center text-sm group-hover:bg-red-500 group-hover:text-white transition-colors">{String.fromCharCode(65+i)}</div>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // --- TAMPILAN: RESULT ---
            if (view === 'result') {
                const passed = quizState.finalScore >= 70;
                return (
                    // BACKGROUND SOFT GREY (SLATE-100)
                    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans text-center fade-in">
                        <div className="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl relative overflow-hidden">
                            <div className={`absolute top-0 left-0 w-full h-32 ${passed ? 'bg-green-500' : 'bg-red-500'}`}></div>
                            <div className="relative z-10 bg-white w-24 h-24 mx-auto rounded-full flex items-center justify-center text-5xl shadow-xl mt-12 mb-6">
                                {passed ? 'üèÜ' : 'üìö'}
                            </div>
                            <h2 className="text-slate-700 text-4xl font-black mb-1">{quizState.finalScore}</h2>
                            <p className="text-slate-400 font-bold text-sm uppercase tracking-wider mb-8">{passed ? 'Lulus Kompetensi' : 'Perlu Belajar Lagi'}</p>
                            <div className="bg-slate-50 rounded-xl p-4 mb-6 text-sm text-slate-500">
                                {passed ? "Kerja bagus! Baginda Raja pasti bangga." : "Jangan menyerah, coba baca materi sekali lagi."}
                            </div>
                            <button onClick={() => setView('dashboard')} className="w-full bg-slate-600 text-white py-4 rounded-xl font-bold hover:bg-slate-700 shadow-lg">
                                Kembali ke Dashboard
                            </button>
                        </div>
                    </div>
                );
            }

            // --- FITUR 3: DETAIL SISWA (RAPOR MINI) ---
            if (view === 'studentDetail' && selectedStudent) {
                const avgScore = selectedStudent.scores && Object.values(selectedStudent.scores).length > 0 
                    ? Math.round(Object.values(selectedStudent.scores).reduce((a,b)=>a+b,0)/Object.values(selectedStudent.scores).length) 
                    : 0;

                return (
                    <Layout notification={notification} userData={userData} handleLogout={handleLogout}>
                        <button onClick={() => setView('dashboard')} className="flex items-center gap-2 text-slate-500 font-bold hover:text-slate-800 mb-6 transition-colors">
                            <ChevronLeft size={20}/> Kembali ke Dashboard
                        </button>

                        <div className="bg-white rounded-3xl overflow-hidden shadow-xl border border-slate-100 max-w-2xl mx-auto">
                            <div className="bg-slate-600 text-white p-8">
                                <div className="flex items-center gap-4">
                                    <div className="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center text-2xl font-bold">
                                        {selectedStudent.name.charAt(0)}
                                    </div>
                                    <div>
                                        <h2 className="text-2xl font-bold">{selectedStudent.name}</h2>
                                        <p className="opacity-80 font-medium">Kelas {selectedStudent.kelas} - {selectedStudent.jurusan}</p>
                                    </div>
                                    <div className="ml-auto text-center">
                                        <div className="text-xs uppercase opacity-70 font-bold">Rata-Rata</div>
                                        <div className="text-4xl font-black">{avgScore}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-8">
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700"><FileText className="text-red-600"/> Rincian Nilai Per Modul</h3>
                                <div className="space-y-3">
                                    {selectedStudent.scores ? Object.entries(selectedStudent.scores).map(([modId, score]) => {
                                        // Cari judul modul berdasarkan ID
                                        const modTitle = modules.find(m => m.id === modId)?.title || "Modul Tidak Dikenal ("+modId+")";
                                        return (
                                            <div key={modId} className="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
                                                <div className="font-bold text-slate-600">{modTitle}</div>
                                                <div className={`font-black text-lg ${score >= 75 ? 'text-green-600' : 'text-red-500'}`}>{score}</div>
                                            </div>
                                        );
                                    }) : <p className="text-slate-400 italic">Belum ada nilai yang terekam.</p>}
                                    
                                    {selectedStudent.scores && Object.keys(selectedStudent.scores).length === 0 && (
                                        <p className="text-slate-400 italic">Siswa ini belum mengerjakan kuis apapun.</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </Layout>
                );
            }
            return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400 font-bold">Memuat Aplikasi...</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
